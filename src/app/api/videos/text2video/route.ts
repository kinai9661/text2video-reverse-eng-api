import{NextRequest,NextResponse}from'next/server';const U='https://app-9kpm005bczy9-vitesandbox.sandbox.medo.dev/functions/v1/video-api/v1/videos/text2video';const S={'kling-2.6':'kling','kling-1.6':'kling','runway-gen4.5':'runway','runway-gen3':'runway','veo-3.1':'veo','sora-2':'sora','default':'kling'};const V={'kling-2.6':'kling-v1','runway-gen4.5':'gen4','veo-3.1':'veo3.1','default':'kling-v1'};const F={'kling-2.6':'kling-v2.6-master','runway-gen4.5':'runway-gen4.5-turbo','veo-3.1':'veo-3.1-master','default':'kling-v2.6-master'};const A=1;const M=A===1?S:A===2?V:F;const N=A===1?'SIMPLE':A===2?'VERSIONED':'FULL';export async function POST(req:NextRequest){try{const b=await req.json();const t=process.env.SUPABASE_TOKEN;if(!t||t==='your-supabase-token-here'){return NextResponse.json({error:{code:'missing_token',message:'Token not configured'}},{status:500})}const r:any={model_name:M[b.model]||M['default'],prompt:b.prompt,aspect_ratio:b.aspect_ratio||'16:9',duration:String(b.seconds||5)};if(b.image)r.image_url=b.image;console.log('üöÄ',U,'|',N,'|',b.model,'‚Üí',r.model_name);const s=Date.now();const res=await fetch(U,{method:'POST',headers:{'Authorization':`Bearer ${t}`,'Content-Type':'application/json'},body:JSON.stringify(r)});const rt=Date.now()-s;console.log('‚è±',rt+'ms','|',res.status);if(!res.ok){const e=await res.text();console.error('‚ùå',res.status,e);if(res.status===404){console.error('üí° Try: ACTIVE_SCHEME='+(A===3?1:A+1)+' or npm run detect')}return NextResponse.json({error:{code:`api_error_${res.status}`,message:`HTTP ${res.status}`,status:res.status,current_scheme:N,model_tried:r.model_name,suggestion:res.status===404?`Change ACTIVE_SCHEME to ${A===3?1:A+1} or run: npm run detect`:null}},{status:res.status})}const d=await res.json();console.log('‚úÖ',d.task_id||d.id);return NextResponse.json({id:d.task_id||d.id||`task_${Date.now()}`,status:d.status||'pending',video_url:d.video_url||null,model:r.model_name,scheme:N,metadata:d})}catch(err:any){console.error('‚ùå',err.message);return NextResponse.json({error:{code:'internal_error',message:err.message}},{status:500})}}